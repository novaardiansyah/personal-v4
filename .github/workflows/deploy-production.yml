name: Deploy Production Application to Server (ZIP Deploy)

on:
  push:
    branches: [production]

jobs:
  build-and-deploy:
    runs-on: nova-local

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. Setup PHP to build vendor on runner
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, bcmath, curl, xml, intl, gd, mysql

      # 2. Install Composer Dependencies (no dev)
      - name: Install Composer Dependencies
        run: |
          composer install --no-dev --prefer-dist --optimize-autoloader

      # 3. Create Deployment ZIP (tanpa folder .git, vendor dibawa)
      - name: Create Deployment ZIP
        run: |
          powershell Compress-Archive -Force -Path .\* -DestinationPath deploy.zip

      # 4. Upload ZIP to server
      - name: Upload Deployment ZIP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          port: ${{ secrets.PRODUCTION_PORT }}
          source: "deploy.zip"
          target: ${{ secrets.PRODUCTION_PATH }}

      # 5. SSH - Clean live-app/, extract zip, merge setup/, run artisan
      - name: SSH Deploy Application
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          port: ${{ secrets.PRODUCTION_PORT }}
          script: |
            cd ${{ secrets.PRODUCTION_PATH }}

            echo "üßπ Menghapus semua isi folder live-app/"
            rm -rf live-app
            mkdir live-app

            echo "üì¶ Extract deploy.zip ke folder live-app/"
            unzip -o deploy.zip -d live-app
            rm deploy.zip

            echo "üìÇ Copy semua isi setup/ ke dalam live-app/"
            cp -r setup/* live-app/

            cd live-app

            echo "üîê Set permission"
            chmod -R 775 storage bootstrap/cache
            chown -R www-data:www-data storage bootstrap/cache

            echo "üîß Laravel optimize"
            php artisan optimize:clear
            php artisan migrate --force
            php artisan filament:optimize || true
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan event:cache

            echo "‚öô Restart supervisor"
            cp deploy/supervisor/${{ secrets.PRODUCTION_SUPERVISOR_PREFIX }}-queue.conf /etc/supervisor/conf.d/
            cp deploy/supervisor/${{ secrets.PRODUCTION_SUPERVISOR_PREFIX }}-schedule.conf /etc/supervisor/conf.d/
            sudo supervisorctl reread
            sudo supervisorctl update
            sudo supervisorctl restart ${{ secrets.PRODUCTION_SUPERVISOR_PREFIX }}-queue
            sudo supervisorctl restart ${{ secrets.PRODUCTION_SUPERVISOR_PREFIX }}-schedule
